<section id="waitlist" class="py-20">
  <div class="mx-auto w-full max-w-6xl px-4">
    <div class="card border border-base-300 bg-base-200/70" data-reveal style="--delay:0.05s">
      <div class="card-body gap-8 lg:flex-row lg:items-center">
        <div class="flex-1">
          <p class="text-xs uppercase tracking-[0.3em] text-base-content/50 accent-gradient">Early access</p>
          <h2 class="mt-3 text-3xl font-semibold md:text-4xl">
            Join the <span class="accent-gradient">waitlist</span>
          </h2>
          <p class="mt-3 text-base-content/70">Be the first to try TrueSpec and get product updates.</p>
          <div class="mt-4 flex flex-wrap gap-2">
            <span class="badge badge-outline">CLI preview</span>
            <span class="badge badge-outline">GitHub Action</span>
            <span class="badge badge-outline">Private beta</span>
          </div>
        </div>

        <div class="flex-1">
          <form class="join w-full" data-waitlist-form action="/api/waitlist" method="post">
            <label class="sr-only" for="waitlist-email">Email address</label>
            <input
              id="waitlist-email"
              class="input input-bordered join-item w-full"
              type="email"
              name="email"
              placeholder="you@company.com"
              autocomplete="email"
              required
            />
            <button class="btn btn-primary join-item" type="submit">Join waitlist</button>
          </form>

          <p
            class="status mt-2 text-sm min-h-[1.2em] text-base-content/60"
            data-waitlist-status
            role="status"
            aria-live="polite"
          ></p>
          <p class="text-xs text-base-content/50">No spam. Only early access updates.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  const form = document.querySelector("[data-waitlist-form]");
  const status = document.querySelector("[data-waitlist-status]");

  if (form instanceof HTMLFormElement && status instanceof HTMLElement) {
    const button = form.querySelector('button[type="submit"]');
    const setStatus = (message, state) => {
      status.textContent = message;
      status.dataset.state = state;
    };
    const track = (state) => {
      if (typeof window.truespecTrack === "function") {
        window.truespecTrack("waitlist_submit", {
          status: state,
          source: "waitlist_form",
        });
      }
    };

    setStatus("", "idle");

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      setStatus("Submitting...", "loading");
      if (button instanceof HTMLButtonElement) {
        button.disabled = true;
      }

      try {
        const formData = new FormData(form);
        const email = formData.get("email");

        const response = await fetch(form.action, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ email }),
        });

        if (!response.ok) {
          const message = await response.text();
          throw new Error(message || `Request failed (${response.status})`);
        }

        form.reset();
        setStatus("Thanks. You are on the list.", "success");
        track("success");
      } catch (error) {
        setStatus("Something went wrong. Please try again.", "error");
        track("error");
      } finally {
        if (button instanceof HTMLButtonElement) {
          button.disabled = false;
        }
      }
    });
  }
</script>

<style>
  .status[data-state="success"] {
    color: #22c55e;
  }

  .status[data-state="error"] {
    color: #f87171;
  }
</style>
