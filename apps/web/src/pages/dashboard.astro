---
import BaseLayout from "../layouts/BaseLayout.astro";
import Footer from "../components/Footer.astro";
import SiteNav from "../components/SiteNav.astro";
---

<BaseLayout
  title="TrueSpec - Dashboard"
  description="Internal metrics dashboard for waitlist signals and drift reports."
  canonical="https://truespec-app.com/dashboard"
  robots="noindex,nofollow"
>
  <SiteNav />

  <section class="py-20">
    <div class="mx-auto w-full max-w-6xl px-4">
      <div class="max-w-2xl" data-reveal style="--delay:0s">
        <p class="text-xs uppercase tracking-[0.3em] text-base-content/50 accent-gradient">Ops</p>
        <h1 class="mt-3 text-3xl font-semibold md:text-4xl">Ops dashboard</h1>
        <p class="mt-4 text-base-content/70">
          Internal view of early-access demand and spec drift reports. Enter the tokens to load data.
        </p>
      </div>

      <div class="mt-8 card border border-base-300 bg-base-200/70">
        <div class="card-body gap-4">
          <form class="flex flex-wrap items-center gap-3" data-dashboard-form>
            <input
              class="input input-bordered flex-1 min-w-[220px]"
              type="password"
              name="token"
              placeholder="Admin token"
              autocomplete="current-password"
              data-dashboard-token
              required
            />
            <button class="btn btn-primary" type="submit">Load metrics</button>
            <button class="btn btn-ghost" type="button" data-clear-token>Clear</button>
          </form>
          <div class="flex flex-wrap items-center gap-3 text-xs text-base-content/50">
            <span>Endpoint: /api/waitlist?summary=1</span>
            <span class="text-base-content/30">&middot;</span>
            <span data-updated>Not loaded</span>
          </div>
          <p class="text-sm text-base-content/60 min-h-[1.3em]" data-dashboard-status></p>
        </div>
      </div>

      <div class="mt-8 grid gap-6 md:grid-cols-3">
        <div class="card border border-base-300 bg-base-200/60">
          <div class="card-body">
            <p class="text-xs uppercase tracking-[0.3em] text-base-content/50">Total signups</p>
            <p class="text-3xl font-semibold" data-metric="total">--</p>
            <p class="text-xs text-base-content/50">All time</p>
          </div>
        </div>
        <div class="card border border-base-300 bg-base-200/60">
          <div class="card-body">
            <p class="text-xs uppercase tracking-[0.3em] text-base-content/50">Last 24 hours</p>
            <p class="text-3xl font-semibold" data-metric="last24h">--</p>
            <p class="text-xs text-base-content/50">New signups</p>
          </div>
        </div>
        <div class="card border border-base-300 bg-base-200/60">
          <div class="card-body">
            <p class="text-xs uppercase tracking-[0.3em] text-base-content/50">Last 7 days</p>
            <p class="text-3xl font-semibold" data-metric="last7d">--</p>
            <p class="text-xs text-base-content/50">New signups</p>
          </div>
        </div>
      </div>

      <div class="mt-8 card border border-base-300 bg-base-200/70">
        <div class="card-body gap-4">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-base-content/50">GitHub Action repo</p>
              <h2 class="text-lg font-semibold">TrueSpecAction</h2>
            </div>
            <a
              class="link link-hover text-sm"
              href="https://github.com/alessiobianchini/TrueSpecAction"
              target="_blank"
              rel="noopener"
            >
              View repo
            </a>
          </div>
          <div class="grid gap-4 md:grid-cols-3">
            <div class="rounded-2xl border border-base-300/70 bg-base-100/60 p-4">
              <p class="text-xs uppercase tracking-[0.3em] text-base-content/50">Stars</p>
              <p class="text-2xl font-semibold" data-github="stars">--</p>
            </div>
            <div class="rounded-2xl border border-base-300/70 bg-base-100/60 p-4">
              <p class="text-xs uppercase tracking-[0.3em] text-base-content/50">Forks</p>
              <p class="text-2xl font-semibold" data-github="forks">--</p>
            </div>
            <div class="rounded-2xl border border-base-300/70 bg-base-100/60 p-4">
              <p class="text-xs uppercase tracking-[0.3em] text-base-content/50">Open issues</p>
              <p class="text-2xl font-semibold" data-github="issues">--</p>
            </div>
          </div>
          <p class="text-xs text-base-content/50" data-github-status>Not loaded</p>
        </div>
      </div>

      <div class="mt-8 card border border-base-300 bg-base-200/70">
        <div class="card-body gap-4">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-base-content/50">Reports</p>
              <h2 class="text-lg font-semibold">Spec drift reports</h2>
              <p class="text-sm text-base-content/60">
                Load stored diffs from the reports API.
              </p>
            </div>
          </div>
          <form class="flex flex-wrap items-center gap-3" data-reports-form>
            <input
              class="input input-bordered flex-1 min-w-[220px]"
              type="password"
              name="reportsToken"
              placeholder="Reports admin token"
              autocomplete="current-password"
              data-reports-token
              required
            />
            <input
              class="input input-bordered flex-1 min-w-[220px]"
              type="text"
              name="reportsRepo"
              placeholder="owner/repo"
              autocomplete="off"
              data-reports-repo
              required
            />
            <button class="btn btn-primary" type="submit">Load reports</button>
            <button class="btn btn-ghost" type="button" data-reports-clear>Clear</button>
          </form>
          <div class="flex flex-wrap items-center gap-3 text-xs text-base-content/50">
            <span data-reports-endpoint>Endpoint: /api/reports?repo=owner/repo</span>
            <span class="text-base-content/30">&middot;</span>
            <span data-reports-updated>Not loaded</span>
          </div>
          <p class="text-sm text-base-content/60 min-h-[1.3em]" data-reports-status></p>
        </div>
      </div>

      <div class="mt-8 grid gap-6 lg:grid-cols-[minmax(0,0.7fr)_minmax(0,1.3fr)]">
        <div class="card border border-base-300 bg-base-200/60">
          <div class="card-body">
            <h2 class="text-lg font-semibold">Recent reports</h2>
            <div class="mt-3 overflow-x-auto">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Created</th>
                    <th>Repo</th>
                    <th>Breaking</th>
                    <th>Warning</th>
                    <th>Info</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody data-reports-list>
                  <tr>
                    <td colspan="6" class="text-base-content/50">No data yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card border border-base-300 bg-base-200/60">
          <div class="card-body">
            <h2 class="text-lg font-semibold">Report detail</h2>
            <div class="mt-3 flex flex-wrap items-center gap-3 text-xs text-base-content/60">
              <span class="badge badge-outline" data-report-summary="breaking">Breaking: --</span>
              <span class="badge badge-outline" data-report-summary="warning">Warning: --</span>
              <span class="badge badge-outline" data-report-summary="info">Info: --</span>
              <span class="text-base-content/50" data-report-meta>Pick a report to view details.</span>
            </div>
            <div class="mt-4 rounded-2xl border border-base-300/70 bg-base-100/60 p-4">
              <pre class="text-xs whitespace-pre-wrap font-mono" data-report-markdown>Waiting for a report...</pre>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-10 grid gap-6 lg:grid-cols-[minmax(0,0.6fr)_minmax(0,1.4fr)]">
        <div class="card border border-base-300 bg-base-200/60">
          <div class="card-body">
            <h2 class="text-lg font-semibold">Sources</h2>
            <ul class="mt-3 space-y-2 text-sm text-base-content/70" data-source-list>
              <li class="text-base-content/50">No data yet.</li>
            </ul>
          </div>
        </div>

        <div class="card border border-base-300 bg-base-200/60">
          <div class="card-body">
            <h2 class="text-lg font-semibold">Recent signups</h2>
            <div class="mt-3 overflow-x-auto">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Source</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody data-recent-body>
                  <tr>
                    <td colspan="3" class="text-base-content/50">No data yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <Footer />

  <script type="module">
    const form = document.querySelector("[data-dashboard-form]");
    const tokenInput = document.querySelector("[data-dashboard-token]");
    const statusEl = document.querySelector("[data-dashboard-status]");
    const clearBtn = document.querySelector("[data-clear-token]");
    const updatedEl = document.querySelector("[data-updated]");
    const sourceList = document.querySelector("[data-source-list]");
    const recentBody = document.querySelector("[data-recent-body]");
    const metricTotal = document.querySelector('[data-metric="total"]');
    const metric24h = document.querySelector('[data-metric="last24h"]');
    const metric7d = document.querySelector('[data-metric="last7d"]');
    const githubStatus = document.querySelector("[data-github-status]");
    const githubStars = document.querySelector('[data-github="stars"]');
    const githubForks = document.querySelector('[data-github="forks"]');
    const githubIssues = document.querySelector('[data-github="issues"]');
    const reportsForm = document.querySelector("[data-reports-form]");
    const reportsTokenInput = document.querySelector("[data-reports-token]");
    const reportsRepoInput = document.querySelector("[data-reports-repo]");
    const reportsStatus = document.querySelector("[data-reports-status]");
    const reportsUpdated = document.querySelector("[data-reports-updated]");
    const reportsEndpoint = document.querySelector("[data-reports-endpoint]");
    const reportsList = document.querySelector("[data-reports-list]");
    const reportsClear = document.querySelector("[data-reports-clear]");
    const reportMarkdown = document.querySelector("[data-report-markdown]");
    const reportMeta = document.querySelector("[data-report-meta]");
    const reportBreaking = document.querySelector('[data-report-summary="breaking"]');
    const reportWarning = document.querySelector('[data-report-summary="warning"]');
    const reportInfo = document.querySelector('[data-report-summary="info"]');

    const tokenKey = "truespec_admin_token";
    const reportsTokenKey = "truespec_reports_token";
    const reportsRepoKey = "truespec_reports_repo";
    const githubRepo = "alessiobianchini/TrueSpecAction";
    const githubEndpoint = `https://api.github.com/repos/${githubRepo}`;
    let activeReportsToken = "";
    let activeReportsRepo = "";

    const setStatus = (message, state = "idle") => {
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.classList.remove("text-error", "text-success", "text-warning");
      if (state === "error") statusEl.classList.add("text-error");
      if (state === "success") statusEl.classList.add("text-success");
      if (state === "loading") statusEl.classList.add("text-warning");
    };

    const setMetric = (el, value) => {
      if (!el) return;
      el.textContent = value ?? "--";
    };

    const setGithubStatus = (message, state = "idle") => {
      if (!githubStatus) return;
      githubStatus.textContent = message;
      githubStatus.classList.remove("text-error", "text-success", "text-warning");
      if (state === "error") githubStatus.classList.add("text-error");
      if (state === "success") githubStatus.classList.add("text-success");
      if (state === "loading") githubStatus.classList.add("text-warning");
    };

    const setReportsStatus = (message, state = "idle") => {
      if (!reportsStatus) return;
      reportsStatus.textContent = message;
      reportsStatus.classList.remove("text-error", "text-success", "text-warning");
      if (state === "error") reportsStatus.classList.add("text-error");
      if (state === "success") reportsStatus.classList.add("text-success");
      if (state === "loading") reportsStatus.classList.add("text-warning");
    };

    const setReportBadge = (el, label, value) => {
      if (!el) return;
      el.textContent = `${label}: ${value ?? "--"}`;
    };

    const setReportSummary = (summary) => {
      setReportBadge(reportBreaking, "Breaking", summary?.breaking);
      setReportBadge(reportWarning, "Warning", summary?.warning);
      setReportBadge(reportInfo, "Info", summary?.info);
    };

    const setReportMeta = (message) => {
      if (!reportMeta) return;
      reportMeta.textContent = message;
    };

    const updateReportsEndpoint = (repo) => {
      if (!reportsEndpoint) return;
      const safeRepo = repo || "owner/repo";
      reportsEndpoint.textContent = `Endpoint: /api/reports?repo=${safeRepo}`;
    };

    const formatDate = (value) => {
      if (!value) return "--";
      const parsed = Date.parse(value);
      if (Number.isNaN(parsed)) return String(value);
      return new Date(parsed).toLocaleString();
    };

    const renderSources = (bySource) => {
      if (!sourceList) return;
      sourceList.innerHTML = "";
      const entries = Object.entries(bySource || {}).sort((a, b) => b[1] - a[1]);
      if (entries.length === 0) {
        const li = document.createElement("li");
        li.className = "text-base-content/50";
        li.textContent = "No data yet.";
        sourceList.appendChild(li);
        return;
      }
      entries.forEach(([source, count]) => {
        const li = document.createElement("li");
        li.className = "flex items-center justify-between gap-3";
        li.innerHTML = `<span>${source}</span><span class="text-base-content/50">${count}</span>`;
        sourceList.appendChild(li);
      });
    };

    const renderRecent = (items) => {
      if (!recentBody) return;
      recentBody.innerHTML = "";
      if (!items || items.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = '<td colspan="3" class="text-base-content/50">No data yet.</td>';
        recentBody.appendChild(row);
        return;
      }

      items.forEach((item) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.email || "--"}</td>
          <td>${item.source || "--"}</td>
          <td>${formatDate(item.createdAt || item.timestamp)}</td>
        `;
        recentBody.appendChild(row);
      });
    };

    const renderReportsList = (items) => {
      if (!reportsList) return;
      reportsList.innerHTML = "";
      if (!items || items.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = '<td colspan="6" class="text-base-content/50">No data yet.</td>';
        reportsList.appendChild(row);
        return;
      }

      items.forEach((item) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${formatDate(item.createdAt)}</td>
          <td>${item.repo || "--"}</td>
          <td>${item.summary?.breaking ?? 0}</td>
          <td>${item.summary?.warning ?? 0}</td>
          <td>${item.summary?.info ?? 0}</td>
          <td><button class="btn btn-xs btn-outline" type="button">View</button></td>
        `;
        const button = row.querySelector("button");
        if (button) {
          button.addEventListener("click", () => {
            if (activeReportsToken && item.id) {
              loadReportDetail(activeReportsToken, item.id);
            }
          });
        }
        reportsList.appendChild(row);
      });
    };

    const resetDashboard = () => {
      setMetric(metricTotal, "--");
      setMetric(metric24h, "--");
      setMetric(metric7d, "--");
      renderSources({});
      renderRecent([]);
      if (updatedEl) updatedEl.textContent = "Not loaded";
    };

    const resetReports = () => {
      renderReportsList([]);
      setReportSummary(null);
      setReportMeta("Pick a report to view details.");
      if (reportMarkdown) {
        reportMarkdown.textContent = "Waiting for a report...";
      }
      if (reportsUpdated) reportsUpdated.textContent = "Not loaded";
      updateReportsEndpoint("");
    };

    const loadGithubStats = async () => {
      setGithubStatus("Loading GitHub stats...", "loading");
      try {
        const response = await fetch(githubEndpoint);
        if (!response.ok) {
          throw new Error(`GitHub API error (${response.status})`);
        }
        const data = await response.json();
        setMetric(githubStars, data.stargazers_count ?? "--");
        setMetric(githubForks, data.forks_count ?? "--");
        setMetric(githubIssues, data.open_issues_count ?? "--");
        setGithubStatus(`Updated ${formatDate(data.updated_at)}`, "success");
      } catch (error) {
        setGithubStatus(error?.message || "Failed to load GitHub stats.", "error");
      }
    };

    const loadReportDetail = async (token, reportId) => {
      if (!reportId) return;
      setReportMeta("Loading report...");
      try {
        const response = await fetch(`/api/reports/${reportId}`, {
          headers: {
            "x-report-token": token,
          },
        });

        if (!response.ok) {
          const message = await response.text();
          throw new Error(message || `Request failed (${response.status})`);
        }

        const data = await response.json();
        setReportSummary(data.summary);
        const metaParts = [
          data.id ? `Report ${data.id}` : null,
          data.repo ? data.repo : null,
          data.createdAt ? formatDate(data.createdAt) : null,
        ].filter(Boolean);
        setReportMeta(metaParts.join(" Â· ") || "Report loaded.");
        if (reportMarkdown) {
          reportMarkdown.textContent = data.markdown || "No markdown available.";
        }
      } catch (error) {
        setReportMeta("Failed to load report.");
        if (reportMarkdown) {
          reportMarkdown.textContent = "Unable to load report details.";
        }
        setReportsStatus(error?.message || "Failed to load report.", "error");
      }
    };

    const loadSummary = async (token) => {
      setStatus("Loading metrics...", "loading");
      try {
        const response = await fetch("/api/waitlist?summary=1", {
          headers: {
            "x-waitlist-token": token,
          },
        });

        if (!response.ok) {
          const message = await response.text();
          throw new Error(message || `Request failed (${response.status})`);
        }

        const data = await response.json();
        setMetric(metricTotal, data.total ?? "--");
        setMetric(metric24h, data.last24h ?? "--");
        setMetric(metric7d, data.last7d ?? "--");
        renderSources(data.bySource);
        renderRecent(data.recent);
        if (updatedEl) {
          updatedEl.textContent = `Updated ${formatDate(data.generatedAt)}`;
        }
        setStatus("Metrics loaded.", "success");
      } catch (error) {
        setStatus(error?.message || "Failed to load metrics.", "error");
      }
    };

    const loadReports = async (token, repo) => {
      setReportsStatus("Loading reports...", "loading");
      activeReportsToken = token;
      activeReportsRepo = repo;
      updateReportsEndpoint(repo);

      try {
        const response = await fetch(`/api/reports?repo=${encodeURIComponent(repo)}&limit=20`, {
          headers: {
            "x-report-token": token,
          },
        });

        if (!response.ok) {
          const message = await response.text();
          throw new Error(message || `Request failed (${response.status})`);
        }

        const data = await response.json();
        renderReportsList(data.items || []);
        if (reportsUpdated) {
          reportsUpdated.textContent = `Updated ${formatDate(new Date().toISOString())}`;
        }
        setReportsStatus("Reports loaded.", "success");
        if (data.items && data.items.length > 0) {
          await loadReportDetail(token, data.items[0].id);
        } else {
          setReportSummary(null);
          setReportMeta("No reports found.");
          if (reportMarkdown) {
            reportMarkdown.textContent = "No reports available for this repo.";
          }
        }
      } catch (error) {
        setReportsStatus(error?.message || "Failed to load reports.", "error");
      }
    };

    loadGithubStats();

    if (form instanceof HTMLFormElement && tokenInput instanceof HTMLInputElement) {
      const storedToken = sessionStorage.getItem(tokenKey);
      if (storedToken) {
        tokenInput.value = storedToken;
        loadSummary(storedToken);
      }

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const token = tokenInput.value.trim();
        if (!token) {
          setStatus("Enter the admin token first.", "error");
          return;
        }
        sessionStorage.setItem(tokenKey, token);
        loadSummary(token);
      });
    }

    if (
      reportsForm instanceof HTMLFormElement &&
      reportsTokenInput instanceof HTMLInputElement &&
      reportsRepoInput instanceof HTMLInputElement
    ) {
      const storedToken = sessionStorage.getItem(reportsTokenKey);
      const storedRepo = sessionStorage.getItem(reportsRepoKey);
      if (storedToken) {
        reportsTokenInput.value = storedToken;
      }
      if (storedRepo) {
        reportsRepoInput.value = storedRepo;
        updateReportsEndpoint(storedRepo);
      }
      if (storedToken && storedRepo) {
        loadReports(storedToken, storedRepo);
      }

      reportsForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const token = reportsTokenInput.value.trim();
        const repo = reportsRepoInput.value.trim();
        if (!token || !repo) {
          setReportsStatus("Enter token and repo first.", "error");
          return;
        }
        sessionStorage.setItem(reportsTokenKey, token);
        sessionStorage.setItem(reportsRepoKey, repo);
        loadReports(token, repo);
      });
    }

    if (clearBtn instanceof HTMLButtonElement) {
      clearBtn.addEventListener("click", () => {
        sessionStorage.removeItem(tokenKey);
        if (tokenInput instanceof HTMLInputElement) {
          tokenInput.value = "";
        }
        resetDashboard();
        setStatus("Token cleared.", "idle");
      });
    }

    if (reportsClear instanceof HTMLButtonElement) {
      reportsClear.addEventListener("click", () => {
        sessionStorage.removeItem(reportsTokenKey);
        sessionStorage.removeItem(reportsRepoKey);
        if (reportsTokenInput instanceof HTMLInputElement) {
          reportsTokenInput.value = "";
        }
        if (reportsRepoInput instanceof HTMLInputElement) {
          reportsRepoInput.value = "";
        }
        resetReports();
        setReportsStatus("Token cleared.", "idle");
      });
    }
  </script>
</BaseLayout>
